{% extends 'farm/base.html' %}

{% block extra_css %}
<style>
    .stat-row { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
    .stat-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,.05); padding: 20px; flex: 1; min-width: 180px; text-align: center; }
    .stat-number { font-size: 2em; font-weight: 700; }
    .stat-label { color: #666; font-size: 0.9em; margin-top: 5px; }
    .stat-expense { color: #d32f2f; }
    .stat-income { color: #4caf50; }
    .stat-net { color: #2196f3; }

    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,.05); padding: 25px; margin-bottom: 25px; }
    .card-title { color: #795548; border-bottom: 2px solid #efebe9; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.2em; margin-top: 0; }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; color: #666; font-size: 0.85em; padding: 10px; border-bottom: 2px solid #eee; }
    td { padding: 10px; border-bottom: 1px solid #eee; }
    .text-profit { color: #4caf50; font-weight: 700; }
    .text-loss { color: #d32f2f; font-weight: 700; }

    body.dark-mode .stat-card, body.dark-mode .card { background-color: #1e1e1e; color: #e0e0e0; }
    body.dark-mode .card-title { border-bottom-color: #333; }
    body.dark-mode .stat-label { color: #aaa; }
    body.dark-mode th { color: #aaa; border-bottom-color: #333; }
    body.dark-mode td { border-bottom-color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="container-custom">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6 fw-bold" style="color:#795548;">üí∏ Cost-Per-Goat Analysis</h1>
        <div>
            <a href="{% url 'finance_dashboard' %}" class="btn btn-outline-secondary me-2">üí∞ Finance</a>
            <a href="{% url 'index' %}" class="btn btn-outline-secondary">‚Üê Dashboard</a>
        </div>
    </div>

    <div class="stat-row">
        <div class="stat-card">
            <div class="stat-number stat-expense">${{ total_herd_expenses|floatformat:2 }}</div>
            <div class="stat-label">Total Herd Expenses (Tagged)</div>
        </div>
        <div class="stat-card">
            <div class="stat-number stat-income">${{ total_herd_income|floatformat:2 }}</div>
            <div class="stat-label">Total Herd Income (Tagged)</div>
        </div>
        <div class="stat-card">
            <div class="stat-number stat-net">${{ total_herd_net|floatformat:2 }}</div>
            <div class="stat-label">Net Profit/Loss</div>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">üìä Cost Breakdown by Goat</h3>
        <p style="color:#888; font-size:0.9em;">Only shows goats with tagged transactions. Tag expenses to goats in the Finance page.</p>
        <div style="height:350px; margin-bottom:20px;"><canvas id="costChart"></canvas></div>
    </div>

    <div class="card">
        <h3 class="card-title">üìã Per-Goat Financials</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Goat</th>
                        <th>Feed</th>
                        <th>Vet</th>
                        <th>Equipment</th>
                        <th>Total Expenses</th>
                        <th>Income</th>
                        <th>Net</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in analysis %}
                    <tr>
                        <td><a href="{% url 'goat_detail' a.goat.id %}"><strong>{{ a.goat.name }}</strong></a></td>
                        <td>${{ a.feed_cost|floatformat:2 }}</td>
                        <td>${{ a.vet_cost|floatformat:2 }}</td>
                        <td>${{ a.equip_cost|floatformat:2 }}</td>
                        <td style="color:#d32f2f; font-weight:600;">${{ a.expenses|floatformat:2 }}</td>
                        <td style="color:#4caf50; font-weight:600;">${{ a.income|floatformat:2 }}</td>
                        <td class="{% if a.net >= 0 %}text-profit{% else %}text-loss{% endif %}">
                            {% if a.net >= 0 %}+{% endif %}${{ a.net|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" style="text-align:center; padding:30px; color:#888;">No goat-tagged transactions yet. Tag expenses to goats in the Finance page.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{{ chart_labels|json_script:"chart-labels" }}
{{ chart_expenses|json_script:"chart-expenses" }}
{{ chart_income|json_script:"chart-income" }}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#e0e0e0' : '#333';

    function parseJ(id) { let d = JSON.parse(document.getElementById(id).textContent); if (typeof d === 'string') d = JSON.parse(d); return d; }

    const labels = parseJ('chart-labels');
    const expenses = parseJ('chart-expenses');
    const income = parseJ('chart-income');

    if (labels.length) {
        new Chart(document.getElementById('costChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Expenses', data: expenses, backgroundColor: '#ef5350' },
                    { label: 'Income', data: income, backgroundColor: '#66bb6a' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: textColor } } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: textColor, callback: v => '$' + v } },
                    x: { ticks: { color: textColor } }
                }
            }
        });
    }
});
</script>
{% endblock %}